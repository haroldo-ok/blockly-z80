 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Blockly-Z80 demo</title>

<script type="text/javascript" src="../../FileSaver.js/FileSaver.js"></script>
<script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>

<style>
	html, body {
		background-color: #fff;
		margin: 0;
		padding: 0;
		overflow: hidden;
		height: 100%;
	}
	
	#blockly-editor {
		width: 100%;
		height: 100%;
	}

	#blockly-output {
		width: 100%;
		height: 70%;
	}
	
	#bitz80-output {
		width: 100%;
		height: 30%;
	}
	
	#blockly-editor {
		border: 1px solid #ddd;
	}
	
	#frame-container, #output-container {
		height: 100%;
	}
	
	#frame-container {
		width: 70%;
	}
	
	#output-container {
		position: absolute;
		top: 0;
		left: 70%;
		right: 0;
	}
	
	#bitz80-container {
		display: none;
	}
</style>

</head>

<body>
	<script>
		$.when.apply(this, ['data.asm', 'sms.asm', 'coleco.asm'].map(function(fileName){
			return $.ajax(fileName, { dataType: 'text' })
				.then(function(text){
					this.returnInfo = {
						fileName: fileName,
						text: text
					};
				});
		})).then(
			function(){
				console.log('ASM includes loaded.');
				window.assemblyIncludes = this.reduce(function(o, ret){
					o[ret.returnInfo.fileName] = ret.returnInfo.text;
					return o;
				}, {});
				checkLoaded();
			},
			function(jqXHR, textStatus, errorThrown){
				console.error(errorThrown);
				alert('Failed loading one of the asm includes. ROM generation may not work.');
			}
		);
	
		function blocklyLoaded(blockly) {		
			// Called once Blockly is fully loaded.
			console.debug('Blockly ready');			
            window.Blockly = blockly;
			checkLoaded();
		}
		
		function bitz80Loaded(BitZ80) {
			console.debug('BitZ80 ready');			
			window.BitZ80 = BitZ80;
			
			BitZ80.ASM.fExternalLoader = function(fileName) {
				return assemblyIncludes[fileName];
			}
			
			// Patches the include directive to actually add the included things
			BitZ80.ASM.prototype.originalMatchDirective = BitZ80.ASM.prototype.matchDirective;
			BitZ80.ASM.prototype.matchDirective = function(sOp, sParams) {
				if (!this.sStruct && sOp == 'INCLUDE') {
					var sFile = eval(this.prepareParam(sParams));
					var sCode = BitZ80.ASM.fExternalLoader(sFile);
					var oASM = new BitZ80.ASM();
					oASM.aMem = this.aMem;
					oASM.aData = this.aData;
					oASM.aLabels = this.aLabels;
					oASM.iPointer = this.iPointer;
					oASM.iBegin = this.iBegin;
					oASM.iExec = this.iExec;
					oASM.aTime = this.aTime;
					oASM.iM1 = this.iM1;
					oASM.sLastLabel = this.sLastLabel;
					oASM.sGenType = this.sGenType;
					
					//this.fBreakpoint = null;
					//this.aBreakpoints = null;
					//this.sGenType = 'bin';
					oASM.oParentASM = this;
					oASM.start(sCode);
					
					this.iPointer = oASM.iPointer;
					this.iBegin = oASM.iBegin;
					this.iM1 = oASM.iM1;
					this.sLastLabel = oASM.sLastLabel;
					this.aMem = this.aMem.concat(oASM.aMem);
					
					return true;
				} else {
					return this.originalMatchDirective(sOp, sParams);
				}
			}
			
			checkLoaded();
		}
		
		function checkLoaded() {
			if (window['Blockly'] && window['BitZ80'] && window['assemblyIncludes']) {
				console.debug('Everything is ready');
				
				// Capture Blockly's change event.
				Blockly.addChangeListener(function(){
					var code = Blockly.Z80.workspaceToCode();
					document.getElementById('blockly-output').value = code;
					
					var bzOut = document.getElementById('bitz80-output');
					bzOut.value = '';
					
					var asm = new BitZ80.ASM();
					BitZ80.code = null;
					
					try {
						asm.start(code);
						asm.evaluateData();
						asm.patch();
					
						BitZ80.code = asm.aMem;
						BitZ80.labels = asm.aLabels;
						
						bzOut.value = 'OK';
					} catch (e) {
						bzOut.value = e;
					}
				});
				
				// Capture 'Save ROM' button click
				document.getElementById('save-rom').addEventListener('click', function(){
					var bytes = new Uint8Array(BitZ80.code)
					var blob = new Blob([bytes], {type: "application/octet-stream"});
					saveAs(blob, 'bitz80.sms');
				});
			} else {
				// Still waiting for dependencies to load
			}			
		}
	</script>
	
	<div id="frame-container">
		<iframe id="blockly-editor" src="frame.html"></iframe>
	</div>
	<div id="output-container">
		<div id="button-container">
			<button id="save-rom">Save ROM</button>
		</div>
		<textarea id="blockly-output"></textarea>
		<textarea id="bitz80-output"></textarea>
	</div>
	
	<iframe id="bitz80-container" src="bitz80-frame.html"></iframe>
		
</body>

</html> 