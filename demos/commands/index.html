 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Blockly-Z80 demo</title>

<script type="text/javascript" src="../../FileSaver.js/FileSaver.js"></script>
<script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../../js/underscore-min.js"></script>
<script type="text/javascript" src="../../js/js80-browserified.min.js"></script>

<style>
	html, body {
		background-color: #fff;
		margin: 0;
		padding: 0;
		overflow: hidden;
		height: 100%;
	}
	
	#blockly-editor {
		width: 100%;
		height: 100%;
	}

	#blockly-output {
		width: 100%;
		height: 70%;
	}
	
	#bitz80-output {
		width: 100%;
		height: 30%;
	}
	
	#blockly-editor {
		border: 1px solid #ddd;
	}
	
	#frame-container, #output-container {
		height: 100%;
	}
	
	#frame-container {
		width: 70%;
	}
	
	#output-container {
		position: absolute;
		top: 0;
		left: 70%;
		right: 0;
	}
	
	#bitz80-container {
		display: none;
	}
</style>

</head>

<body>
	<script>
		$.when.apply(this, ['data.asm', 'sms.asm', 'coleco.asm', 'sg-1000.asm', 'common.asm'].map(function(fileName){
			return $.ajax(fileName, { dataType: 'text' })
				.then(function(text){
					this.returnInfo = {
						fileName: fileName,
						text: text
					};
				});
		})).then(
			function(){
				console.log('ASM includes loaded.');
				window.assemblyIncludes = this.reduce(function(o, ret){
					o[ret.returnInfo.fileName] = ret.returnInfo.text;
					return o;
				}, {});
				checkLoaded();
			},
			function(jqXHR, textStatus, errorThrown){
				console.error(errorThrown);
				alert('Failed loading one of the asm includes. ROM generation may not work.');
			}
		);
	
		function blocklyLoaded(blockly) {		
			// Called once Blockly is fully loaded.
			console.debug('Blockly ready');			
            window.Blockly = blockly;
			checkLoaded();
		}		

		JS80.fileExists = function(fileName) {
			return true;
		};
		JS80.readFile = function(fileName) {
			if (fileName == 'main.asm') {
				return JS80.source;
			} else if (fileName == 'hardware.asm') {
				var mapping = {
					'sms': 'sms.asm',
					'sg': 'sg-1000.asm'
				};
				fileName = mapping[$('#hardware-type').val()];
				return assemblyIncludes[fileName] + '\n\n' + assemblyIncludes['common.asm'];
			}				
			return assemblyIncludes[fileName];
		};
		
		function checkLoaded() {
			if (window['Blockly'] && window['assemblyIncludes']) {
				console.debug('Everything is ready');
				
				JS80.compile = function(){
					var code = [
						'include "sms.asm"',
						'include "common.asm"',
						Blockly.Z80.workspaceToCode(),
						'include "data.asm"'
					].join('\n');
					document.getElementById('blockly-output').value = code;
					
					var bzOut = document.getElementById('bitz80-output');
					bzOut.value = '';
					
					var asm = new JS80();
					asm.searchPath = ['.']
					JS80.source = null;
					JS80.code = null;
					
					try {
						JS80.source = code;
						asm.compileFile('main.asm');
						asm.secondPass();
					
						JS80.code = asm.buildImage();
						
						bzOut.value = 'OK';
					} catch (e) {
						if (asm.errors.hasErrors()) {
							bzOut.value = _.chain(asm.errors.errors)
								.sortBy('fileName')
								.sortBy('msg')
								.sortBy('macro')
								.sortBy('lineIndex')
								.map(function(err){ 
									if (err.macro) {
										return [
											err.fileName, ':',
											err.lineIndex, ': ',
											err.msg,
											' while executing macro ',
											err.macro
										].join('');
									} else {
										return [
											err.fileName, ':',
											err.lineIndex, ': ',
											err.msg
										].join('');
									}
								})
								.value().join('\n');
						} else {
							bzOut.value = e;
						}	
					}
				}

				// Capture Blockly's change event.
				Blockly.addChangeListener(JS80.compile);
				
				// Capture 'Target Hardware' select
				$('#hardware-type').change(JS80.compile);
				
				// Capture 'Save ROM' button click
				document.getElementById('save-rom').addEventListener('click', function(){
					var bytes = new Uint8Array(BitZ80.code)
					var blob = new Blob([bytes], {type: "application/octet-stream"});
					var ext = $('#hardware-type').val();
					saveAs(blob, 'bitz80.' + ext);
				});
			} else {
				// Still waiting for dependencies to load
			}			
		}
	</script>
	
	<div id="frame-container">
		<iframe id="blockly-editor" src="frame.html"></iframe>
	</div>
	<div id="output-container">
		<div id="button-container">
			<select id="hardware-type">
				<option value="sms" selected="selected">Sega Master System</option>
				<option value="sg">SG-1000</option>
			</select>
			<button id="save-rom">Save ROM</button>
		</div>
		<textarea id="blockly-output"></textarea>
		<textarea id="bitz80-output"></textarea>
	</div>
		
</body>

</html> 